name: Build and Release Barrel

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build-barrel:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # --- 1. INSTALL SDK ---
      - name: Fetch and Install SDK
        id: install_sdk
        shell: bash
        run: |
          SDK_LIST_URL="https://developer.garmin.com/downloads/connect-iq/sdks/sdks.json"
          BASE_URL="https://developer.garmin.com/downloads/connect-iq/sdks/"
          
          echo "Fetching SDK list..."
          RESPONSE=$(curl -sL "$SDK_LIST_URL")
          
          # Find latest Linux version (Semantic Versioning Sort)
          LATEST_ENTRY=$(echo "$RESPONSE" | jq 'map(select(.linux != null)) | sort_by(.version | split(".") | map(tonumber)) | last')
          FILENAME=$(echo "$LATEST_ENTRY" | jq -r '.linux')
          
          if [ -z "$FILENAME" ] || [ "$FILENAME" == "null" ]; then
            echo "::error::Could not find SDK filename."
            exit 1
          fi

          FULL_URL="${BASE_URL}${FILENAME}"
          echo "Downloading SDK: $FILENAME"
          
          wget -q "$FULL_URL" -O sdk.zip
          unzip -q sdk.zip -d sdk_extracted
          
          # Find path to barrelbuild to locate the BIN directory
          BARRELBUILD_PATH=$(find sdk_extracted -name "barrelbuild" -type f | head -n 1)
          SDK_BIN_DIR=$(dirname "$BARRELBUILD_PATH")
          
          echo "sdk_bin=$SDK_BIN_DIR" >> $GITHUB_OUTPUT

      # --- 2. INSTALL DEVICES (THE FIX) ---
      - name: Install Required Devices
        shell: bash
        run: |
          # 1. Setup the directory structure Garmin expects
          mkdir -p $HOME/.Garmin/ConnectIQ/Devices
          
          # 2. Download a helper script that parses manifest.xml and downloads devices
          # Source: https://github.com/flocsy/garmin-dev-tools
          wget -q https://raw.githubusercontent.com/flocsy/garmin-dev-tools/main/cj-download-devices.sh
          chmod +x cj-download-devices.sh
          
          echo "Parsing manifest.xml and downloading devices..."
          # Arguments: <manifest_file> <output_dir> <token_is_optional>
          ./cj-download-devices.sh manifest.xml $HOME/.Garmin/ConnectIQ/Devices
          
          echo "Devices installed:"
          ls $HOME/.Garmin/ConnectIQ/Devices

      # --- 3. BUILD BARREL ---
      - name: Build Barrel
        id: build
        run: |
          SDK_BIN="${{ steps.install_sdk.outputs.sdk_bin }}"
          BARREL_NAME="MonkeyUtils.barrel"
          JUNGLE_FILE="monkey.jungle"
          
          chmod +x "$SDK_BIN/barrelbuild"
          
          echo "Building $BARREL_NAME..."
          
          # Build command
          "$SDK_BIN/barrelbuild" \
            -o "$BARREL_NAME" \
            -f "$JUNGLE_FILE"
          
          if [ -f "$BARREL_NAME" ]; then
            echo "Build success! File size:"
            ls -lh "$BARREL_NAME"
            echo "barrel_path=$BARREL_NAME" >> $GITHUB_OUTPUT
          else
            echo "::error::Build failed. $BARREL_NAME was not created."
            exit 1
          fi

      # --- 4. UPLOAD ARTIFACT ---
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MonkeyUtils-Barrel
          path: ${{ steps.build.outputs.barrel_path }}

      # --- 5. RELEASE (Tags Only) ---
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.barrel_path }}
          draft: false
          prerelease: false