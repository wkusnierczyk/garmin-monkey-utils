name: Update SDKs

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  update-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Parse SDK List
        id: fetch_sdk
        shell: bash
        run: |
          # --- CONFIGURATION ---
          # 1. Official Garmin SDK Feed
          SDK_LIST_URL="https://developer.garmin.com/downloads/connect-iq/sdks/sdks.json"
          BASE_DOWNLOAD_URL="https://developer.garmin.com/downloads/connect-iq/sdks/"
          
          echo "Fetching SDK list from: $SDK_LIST_URL"
          
          # 2. Fetch content
          RESPONSE=$(curl -sL "$SDK_LIST_URL")
          
          # 3. Extract the Linux SDK filename
          # The JSON is an array of objects. We take the first one (usually latest) 
          # and select the "linux" key.
          SDK_FILENAME=$(echo "$RESPONSE" | jq -r '.[0].linux // empty')

          if [ -z "$SDK_FILENAME" ] || [ "$SDK_FILENAME" == "null" ]; then
            echo "::error::Could not find a 'linux' SDK entry in the JSON."
            echo "DEBUG: First item keys: $(echo "$RESPONSE" | jq '.[0] | keys')"
            exit 1
          fi

          # 4. Construct Full URL
          # Garmin's JSON usually returns just the filename (e.g., "connectiq-sdk-lin-4.2.4.zip")
          DOWNLOAD_URL="${BASE_DOWNLOAD_URL}${SDK_FILENAME}"

          echo "Found SDK Filename: $SDK_FILENAME"
          echo "Full Download URL: $DOWNLOAD_URL"
          
          # 5. Output for next steps
          echo "url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Download SDK
        run: |
          URL="${{ steps.fetch_sdk.outputs.url }}"
          
          if [ -z "$URL" ]; then
            echo "::error::No URL passed from previous step."
            exit 1
          fi
          
          echo "Downloading from: $URL"
          wget -q "$URL" -O sdk_archive.zip
          
          echo "Download complete. File size:"
          ls -lh sdk_archive.zip