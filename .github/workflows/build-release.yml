name: Build and Release Barrel

on:
  push:
    branches: ["**"]       # Build on every branch push
    tags: ["v*"]           # Release on tags starting with 'v'
  workflow_dispatch:       # Manual trigger button

jobs:
  build-barrel:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Install SDK
        id: install_sdk
        shell: bash
        run: |
          SDK_LIST_URL="https://developer.garmin.com/downloads/connect-iq/sdks/sdks.json"
          BASE_URL="https://developer.garmin.com/downloads/connect-iq/sdks/"
          
          echo "Fetching SDK list..."
          RESPONSE=$(curl -sL "$SDK_LIST_URL")
          
          # Find latest Linux version (Semantic Versioning Sort)
          LATEST_ENTRY=$(echo "$RESPONSE" | jq 'map(select(.linux != null)) | sort_by(.version | split(".") | map(tonumber)) | last')
          FILENAME=$(echo "$LATEST_ENTRY" | jq -r '.linux')
          
          if [ -z "$FILENAME" ] || [ "$FILENAME" == "null" ]; then
            echo "::error::Could not find SDK filename."
            exit 1
          fi

          FULL_URL="${BASE_URL}${FILENAME}"
          echo "Downloading SDK from: $FULL_URL"
          
          wget -q "$FULL_URL" -O sdk.zip
          unzip -q sdk.zip -d sdk_extracted
          
          # Locate the inner SDK folder
          SDK_ROOT=$(find sdk_extracted -maxdepth 1 -type d -name "connectiq-sdk-*" | head -n 1)
          echo "SDK installed at: $SDK_ROOT"
          echo "sdk_root=$SDK_ROOT" >> $GITHUB_OUTPUT

      - name: Build Barrel
        id: build
        run: |
          SDK_BIN="${{ steps.install_sdk.outputs.sdk_root }}/bin"
          BARREL_NAME="MonkeyUtils.barrel"
          JUNGLE_FILE="monkey.jungle"
          
          # Ensure build tool is executable
          chmod +x "$SDK_BIN/barrelbuild"
          
          echo "Building $BARREL_NAME..."
          
          # Build command (No developer key)
          "$SDK_BIN/barrelbuild" \
            -o "$BARREL_NAME" \
            -f "$JUNGLE_FILE"
          
          echo "Build success!"
          ls -lh "$BARREL_NAME"
          
          # Output path for next steps
          echo "barrel_path=$BARREL_NAME" >> $GITHUB_OUTPUT

      # --- Upload Artifact (Runs on every push) ---
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MonkeyUtils-Barrel
          path: ${{ steps.build.outputs.barrel_path }}

      # --- Create Release (Runs ONLY on Tag push) ---
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.barrel_path }}
          draft: false
          prerelease: false