name: Update SDKs

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  update-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Parse SDK List
        id: fetch_sdk
        shell: bash
        run: |
          SDK_LIST_URL="https://developer.garmin.com/downloads/connect-iq/sdks/sdks.json"
          BASE_DOWNLOAD_URL="https://developer.garmin.com/downloads/connect-iq/sdks/"
          
          echo "Fetching SDK list from: $SDK_LIST_URL"
          RESPONSE=$(curl -sL "$SDK_LIST_URL")
          
          # --- DEBUG START ---
          # Print the keys of the first item to verify structure (check logs if this fails)
          echo "Debug: JSON Keys found in first item:"
          echo "$RESPONSE" | jq '.[0] | keys'
          # --- DEBUG END ---

          # LOGIC:
          # 1. select(.linux): Ignore entries that don't have a Linux download
          # 2. sort_by(...): Split "6.2.0" into [6,2,0] to sort numerically (so 3.10 > 3.9)
          # 3. last: Take the highest version
          
          LATEST_ENTRY=$(echo "$RESPONSE" | jq 'map(select(.linux != null)) | sort_by(.version | split(".") | map(tonumber)) | last')
          
          SDK_FILENAME=$(echo "$LATEST_ENTRY" | jq -r '.linux')
          SDK_VERSION=$(echo "$LATEST_ENTRY" | jq -r '.version')

          if [ -z "$SDK_FILENAME" ] || [ "$SDK_FILENAME" == "null" ]; then
            echo "::error::Could not find a 'linux' SDK entry."
            exit 1
          fi

          FULL_URL="${BASE_DOWNLOAD_URL}${SDK_FILENAME}"
          
          echo "----------------------------------------"
          echo "Selected SDK Version: $SDK_VERSION"
          echo "Selected Filename:    $SDK_FILENAME"
          echo "----------------------------------------"
          
          echo "url=$FULL_URL" >> $GITHUB_OUTPUT

      - name: Download SDK
        run: |
          URL="${{ steps.fetch_sdk.outputs.url }}"
          echo "Downloading from: $URL"
          wget -q "$URL" -O sdk.zip
          ls -lh sdk.zip