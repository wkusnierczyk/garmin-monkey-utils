name: Update SDKs

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch the official list of SDKs
        id: fetch_sdk
        shell: bash
        run: |
          # 1. Define the Source URL (Replace with your actual URL)
          SDK_URL="YOUR_JSON_SOURCE_URL_HERE"
          
          echo "Fetching SDK list from: $SDK_URL"
          
          # 2. Fetch the content
          RESPONSE=$(curl -sL "$SDK_URL")
          
          # 3. DEBUG: Check if response is valid JSON (Optional but recommended)
          if ! echo "$RESPONSE" | jq empty; then
            echo "::error::Failed to parse JSON response"
            echo "$RESPONSE" | head -n 10
            exit 1
          fi

          # 4. Extract URL (THE FIX IS HERE)
          # We use '.[]' instead of '.sdks[]' because the root is an array.
          # This example grabs the URL of the *first* item in the list.
          # Adjust the select() logic if you need a specific version.
          
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.[0].url // empty')
          
          # Alternative: If you need to find a specific match, e.g., linux version:
          # DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.[] | select(.platform=="linux") | .url' | head -n 1)

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "::error::Could not extract a download URL. Check jq logic."
            # Debug: print structure to see keys
            echo "$RESPONSE" | jq '.[0] | keys'
            exit 1
          fi

          echo "Found SDK URL: $DOWNLOAD_URL"
          echo "url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Download SDK
        run: |
          URL="${{ steps.fetch_sdk.outputs.url }}"
          echo "Downloading SDK from: $URL"
          
          if [ -z "$URL" ]; then
            echo "Error: URL is empty"
            exit 1
          fi
          
          wget -q "$URL" -O sdk_archive.zip
          ls -lh sdk_archive.zip