name: Build Garmin Barrel

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Check out your code
    - uses: actions/checkout@v4

    # 2. Setup Java (Required for Garmin SDK tools)
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Download and Extract the Connect IQ SDK
    - name: Install Connect IQ SDK
      run: |
        # Use a specific recent SDK version (Check developer.garmin.com for latest)
        SDK_URL="https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-lin-7.4.3-2024-12-11-6b2089601.zip"
        
        wget -q -O sdk.zip $SDK_URL
        unzip -q sdk.zip -d sdk_extracted
        
        # Make the binaries executable
        chmod +x sdk_extracted/bin/*
        
        # Initialize the global config file so sdkmanager knows where to write
        # (This prevents some "path not found" errors)
        mkdir -p ~/.Garmin/ConnectIQ
        echo "current-sdk=$(pwd)/sdk_extracted" > ~/.Garmin/ConnectIQ/current-sdk.cfg

    # 4. Generate a Developer Key (Required for signing/building)
    - name: Generate Developer Key
      run: |
        openssl genrsa -out developer_key.pem 4096
        openssl pkcs8 -topk8 -inform PEM -outform DER -in developer_key.pem -out developer_key.der -nocrypt

    # 5. [NEW] Download Target Devices
    # This parses manifest.xml for 'iq:product id' and passes them to sdkmanager
    - name: Download Devices
      run: |
        # Create the standard device directory
        mkdir -p ~/.Garmin/ConnectIQ/Devices
        
        # Extract device IDs from manifest.xml (e.g., "fr245 fenix6")
        # Adjust 'manifest.xml' path if your file is in a subdirectory
        DEVICES=$(grep 'iq:product id' manifest.xml | sed 's/.*id="\([^"]*\)".*/\1/' | tr '\n' ' ')
        
        echo "Detected devices in manifest: $DEVICES"
        
        if [ -z "$DEVICES" ]; then
          echo "Error: No devices found in manifest.xml!"
          exit 1
        fi
        
        # Download the devices (pipe 'yes' to accept any licenses automatically)
        yes | ./sdk_extracted/bin/sdkmanager --download $DEVICES

    # 6. Build the Barrel
    - name: Build Monkey Barrel
      run: |
        # Ensure the output directory exists if needed
        mkdir -p bin
        
        # Run the build command
        java -jar sdk_extracted/bin/barrelbuild.jar \
          -o bin/MonkeyUtils.barrel \
          -f monkey.jungle \
          -y developer_key.der